-- Create Database
CREATE DATABASE GoFishDB
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;

USE GoFishDB;

-- Players Table
CREATE TABLE Players (
    player_id INT AUTO_INCREMENT PRIMARY KEY,
    handle VARCHAR(50) NOT NULL UNIQUE,
    registration_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    games_played INT DEFAULT 0,
    games_won INT DEFAULT 0
) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- Games Table
CREATE TABLE Games (
    game_id INT AUTO_INCREMENT PRIMARY KEY,
    game_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    winner_id INT NULL,
    player_score INT NOT NULL,
    computer_score INT NOT NULL,
    FOREIGN KEY (winner_id) REFERENCES Players(player_id) ON DELETE SET NULL
) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- Leaderboard View
CREATE OR REPLACE VIEW Leaderboard AS
SELECT 
    p.handle AS player_handle,
    COUNT(g.game_id) AS games_played,
    SUM(g.player_score) AS total_score,
    SUM(CASE WHEN g.winner_id = p.player_id THEN 1 ELSE 0 END) AS games_won
FROM Players p
LEFT JOIN Games g ON p.player_id = g.winner_id
GROUP BY p.player_id
ORDER BY total_score DESC, games_won DESC
LIMIT 10;
